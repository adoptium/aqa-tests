#!groovy

LABEL=params.LABEL ? params.LABEL : 'ci.role.test&&hw.arch.x86&&sw.os.linux'

stage('Queue') {
    node("$LABEL") {
       cleanWs()
       testBuild()
    }
}

def testBuild() {
	def time_limit = 8
	if(params.TIME_LIMIT) {
		time_limit = params.TIME_LIMIT.toInteger()
	}
	timeout(time: time_limit, unit: 'HOURS') {
		try {
			def TKG_OWNER_BRANCH = params.TKG_OWNER_BRANCH ?: "adoptium:master"
			def tokens = TKG_OWNER_BRANCH.split(':');
			if (tokens.size() != 2) {
				assert false : "TKG_OWNER_BRANCH ${TKG_OWNER_BRANCH} is not expected format. (i.e., TKG_OWNER_BRANCH=adoptium:master)"
			}
			def owner = tokens[0];
			def branch = tokens[1];
			sh "curl -OsL https://raw.githubusercontent.com/${owner}/TKG/${branch}/scripts/getDependencies.pl"
			sh "perl ./getDependencies.pl -path . -task default -curlOpts '-L'"
			archiveArtifacts '**/*.jar, **/*.zip, **/*.txt, **/*.gz'
		} finally {
			cleanWs()
		}
	}
}

return this
